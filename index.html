<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Weekly Burndown & Status Distribution - Parallel</title>
  <!-- Load Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Load Papa Parse from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }
    .logo-container {
      text-align: center;
      margin-bottom: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    #filterContainer {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      margin-right: 10px;
      font-weight: bold;
    }
    .chart-container {
      width: 80%;
      max-width: 1000px;
      margin: 0 auto;
      margin-bottom: 40px;
    }
    .bar-chart-container {
      width: 80%;
      max-width: 600px;
      margin: 0 auto;
    }
    /* Navigation Link Style */
    .nav-link {
      text-align: center;
      margin-bottom: 30px;
    }
    .nav-link a {
      text-decoration: none;
      font-size: 1.2em;
      color: #0B3054;
      border: 1px solid #0B3054;
      padding: 8px 16px;
      border-radius: 4px;
    }
    .nav-link a:hover {
      background-color: #0B3054;
      color: white;
    }
  </style>
</head>
<body>

  <!-- Citadel Completions Logo at the top -->
  <div class="logo-container">
    <img src="citadel_logo.png" alt="Citadel Completions" style="max-width: 300px;">
  </div>

  <h1>Engineering Burndown and Status Distribution: Parallel</h1>

  <!-- Navigation to Material Dashboard -->
  <div class="nav-link">
    <a href="material.html">Go to Material Dashboard</a>
  </div>

  <!-- SINGLE DROPDOWN + BUTTON FOR BOTH CHARTS -->
  <div id="filterContainer">
    <label for="ownerSelect">Select Owner:</label>
    <select id="ownerSelect"></select>
    <button id="updateButton">Update Charts</button>
  </div>

  <!-- BURNDOWN CHART (drawings.csv) -->
  <div class="chart-container">
    <canvas id="burndownChart"></canvas>
  </div>

  <!-- STATUS DISTRIBUTION BAR CHART (Hard-coded) -->
  <h2>Status Distribution</h2>
  <div class="bar-chart-container">
    <canvas id="statusChart"></canvas>
  </div>

  <script>
    /********************************************************
     * 1) HARDCODED STATUS DATA (for the bar chart)
     ********************************************************/
    // You provided these totals per owner (All, BDDS, Maverick, Elisen, Cotney, Citadel).
    // We have 6 categories: canceled, released, inCheck, notStarted, redlines, inProgress.
    const statusData = {
      "All":       { canceled:10, released:37, inCheck:4,  notStarted:36, redlines:5,  inProgress:27 },
      "BDDS":      { canceled:0,  released:7,  inCheck:1,  notStarted:5,  redlines:5,  inProgress:13 },
      "Maverick":  { canceled:0,  released:23, inCheck:1,  notStarted:7,  redlines:0,  inProgress:0 },
      "Elisen":    { canceled:0,  released:4,  inCheck:0,  notStarted:3,  redlines:0,  inProgress:9 },
      "Cotney":    { canceled:3,  released:1,  inCheck:1,  notStarted:20, redlines:0,  inProgress:2 },
      "Citadel":   { canceled:2,  released:4,  inCheck:2,  notStarted:3,  redlines:0,  inProgress:2 }
    };

    // The 6 bar chart categories in the correct order:
    const statusLabels = ["Canceled", "Released", "In Check", "Not Started", "Redlines", "In Progress"];

    let statusChartInstance = null; // reference to bar chart

    // We'll define a function to render the status chart for a given owner
    function renderStatusChart(owner) {
      let ownerData = statusData[owner];
      if (!ownerData) {
        ownerData = { canceled:0, released:0, inCheck:0, notStarted:0, redlines:0, inProgress:0 };
      }
      const barData = [
        ownerData.canceled,
        ownerData.released,
        ownerData.inCheck,
        ownerData.notStarted,
        ownerData.redlines,
        ownerData.inProgress
      ];
      if (statusChartInstance) {
        statusChartInstance.destroy();
      }
      const ctx = document.getElementById("statusChart").getContext("2d");
      statusChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels: statusLabels,
          datasets: [{
            label: `Drawings by Status (${owner})`,
            data: barData,
            backgroundColor: [
              "#C49A50", "#4AB7C8", "#FFCD56", "#CCC", "#FF6347", "#0B3054"
            ],
            borderColor: [
              "#C49A50", "#4AB7C8", "#FFCD56", "#999", "#FF6347", "#0B3054"
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: "Status Category" } },
            y: { beginAtZero: true, title: { display: true, text: "Number of Drawings" } }
          },
          plugins: {
            legend: { display: true },
            title: {
              display: true,
              text: `Drawings by Status: ${owner}`
            }
          }
        }
      });
    }

    /********************************************************
     * 2) BURNDOWN CHART CODE (drawings.csv)
     ********************************************************/
    const BURNDOWN_CSV = 'drawings.csv';
    let chartInstance = null; // reference to line chart
    let burndownData = null;  // we'll store parsed CSV data here

    Papa.parse(BURNDOWN_CSV, {
      download: true,
      header: true,
      complete: function(results) {
        burndownData = results.data.filter(row => row.DrawingNumber && row.DrawingNumber.trim() !== "");
        burndownData.forEach(row => {
          if (row.EstimatedCompletionDate) {
            row.EstimatedCompletionDate = normalizeDate(new Date(row.EstimatedCompletionDate));
          }
          if (row.ReleasedDate) {
            row.ReleasedDate = normalizeDate(new Date(row.ReleasedDate));
          }
        });
        const csvOwners = [...new Set(burndownData.map(d => d.DrawingOwner).filter(Boolean))];
        const knownStatusOwners = Object.keys(statusData);
        const combinedOwners = new Set([...csvOwners, ...knownStatusOwners]);
        const ownerSelect = document.getElementById("ownerSelect");
        const sortedOwners = Array.from(combinedOwners).sort();
        sortedOwners.forEach(owner => {
          const option = document.createElement("option");
          option.value = owner;
          option.text = owner;
          ownerSelect.appendChild(option);
        });
        if (combinedOwners.has("All")) {
          ownerSelect.value = "All";
        } else {
          ownerSelect.selectedIndex = 0;
        }
        const initialOwner = ownerSelect.value;
        updateBothCharts(initialOwner);
      }
    });

    function normalizeDate(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function getWeeklyDates(startDate, endDate) {
      const dates = [];
      let current = new Date(startDate);
      while (current.getDay() !== 1) {
        current.setDate(current.getDate() - 1);
      }
      while (current <= endDate) {
        dates.push(new Date(current));
        current.setDate(current.getDate() + 7);
      }
      return dates;
    }

    function formatDate(dateObj) {
      const yyyy = dateObj.getFullYear();
      const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
      const dd = String(dateObj.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function renderBurndownChart(allData, ownerFilter) {
      let data = allData;
      if (ownerFilter !== "All") {
        data = allData.filter(d => d.DrawingOwner === ownerFilter);
      }
      if (data.length === 0) {
        alert(`No data for ${ownerFilter}`);
        if (chartInstance) chartInstance.destroy();
        return;
      }
      const ecdTimes = data.filter(d => d.EstimatedCompletionDate).map(d => d.EstimatedCompletionDate.getTime());
      if (ecdTimes.length === 0) {
        alert(`No valid EstimatedCompletionDate for ${ownerFilter}`);
        if (chartInstance) chartInstance.destroy();
        return;
      }
      const earliestECD = new Date(Math.min(...ecdTimes));
      const allTimes = data.filter(d => d.EstimatedCompletionDate).map(d => d.EstimatedCompletionDate.getTime())
                        .concat(data.filter(d => d.ReleasedDate).map(d => d.ReleasedDate.getTime()));
      const latestDate = new Date(Math.max(...allTimes));
      latestDate.setDate(latestDate.getDate() + 7);
      const weeklyDates = getWeeklyDates(earliestECD, latestDate);
      const totalTasks = data.length;
      const today = normalizeDate(new Date());
      const plannedRemaining = weeklyDates.map(weekDate => {
        const completed = data.filter(d => d.EstimatedCompletionDate && d.EstimatedCompletionDate < weekDate).length;
        return totalTasks - completed;
      });
      const actualRemaining = weeklyDates.map(weekDate => {
        if (weekDate > today) { return null; }
        const completed = data.filter(d => d.ReleasedDate && d.ReleasedDate < weekDate).length;
        return totalTasks - completed;
      });
      if (chartInstance) chartInstance.destroy();
      const ctx = document.getElementById("burndownChart").getContext("2d");
      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: weeklyDates.map(d => formatDate(d)),
          datasets: [
            {
              label: `Planned Remaining (${ownerFilter})`,
              data: plannedRemaining,
              borderColor: "#0B3054",
              backgroundColor: "rgba(11,48,84,0.2)",
              fill: true,
              tension: 0.1
            },
            {
              label: `Actual Remaining (${ownerFilter})`,
              data: actualRemaining,
              borderColor: "#4AB7C8",
              backgroundColor: "rgba(74,183,200,0.2)",
              fill: true,
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: "Week Start (Monday)" } },
            y: { beginAtZero: true, title: { display: true, text: "Drawings Remaining" } }
          },
          plugins: {
            legend: { display: true },
            title: {
              display: true,
              text: `Weekly Burndown: Planned vs Actual (${ownerFilter})`
            }
          }
        }
      });
    }

    function updateBothCharts(owner) {
      renderBurndownChart(burndownData, owner);
      renderStatusChart(owner);
    }

    document.getElementById("updateButton").addEventListener("click", () => {
      const selectedOwner = document.getElementById("ownerSelect").value;
      updateBothCharts(selectedOwner);
    });
  </script>
</body>
</html>
